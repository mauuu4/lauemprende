---
import type { HTMLAttributes } from 'astro/types'

interface Props extends HTMLAttributes<'div'> {
  end: number
  duration?: number
  label: string
  suffix?: string
  prefix?: string
  icon?: any
}

const {
  end,
  duration = 2000,
  label,
  suffix = '',
  prefix = '',
  icon: Icon,
  class: className,
  ...rest
} = Astro.props
---

<div
  class={`group relative flex min-h-[200px] flex-col items-center justify-center gap-4 overflow-hidden rounded-2xl border border-gray-200 bg-white px-8 py-12 shadow-lg transition-all duration-300 hover:-translate-y-2 hover:border-primary/50 hover:shadow-2xl md:py-14 ${className || ''}`}
  {...rest}
>
  <!-- Efecto de fondo -->
  <div class="from-primary/5 absolute inset-0 bg-linear-to-br to-transparent opacity-0 transition-opacity duration-300 group-hover:opacity-100"></div>

  <div class="relative z-10 flex flex-col items-center gap-4">
    {Icon && (
      <div class="bg-primary/10 rounded-full p-3 transition-transform duration-300 group-hover:scale-110">
        <Icon class="text-primary h-10 w-10" />
      </div>
    )}
    <p class="text-xs font-bold uppercase tracking-wider text-gray-500">
      {label}
    </p>
    <div class="flex items-baseline gap-1">
      {
        prefix && (
          <span class="text-primary text-2xl font-semibold md:text-3xl">
            {prefix}
          </span>
        )
      }
      <span
        class="text-primary text-5xl font-bold leading-none md:text-6xl"
        data-end={end}
        data-duration={duration}
      >
        0
      </span>
      {
        suffix && (
          <span class="text-primary text-2xl font-semibold md:text-3xl">
          {suffix}
        </span>
      )
    }
  </div>
</div>

<script>
  function animateCounter(element: HTMLElement) {
    const end = parseInt(element.dataset.end || '0')
    const duration = parseInt(element.dataset.duration || '2000')
    const start = 0
    const startTime = performance.now()

    function easeOutExpo(t: number): number {
      return t === 1 ? 1 : 1 - Math.pow(2, -10 * t)
    }

    function updateCounter(currentTime: number) {
      const elapsed = currentTime - startTime
      const progress = Math.min(elapsed / duration, 1)
      const easedProgress = easeOutExpo(progress)
      const current = Math.floor(start + (end - start) * easedProgress)

      element.textContent = current.toLocaleString('es-ES')

      if (progress < 1) {
        requestAnimationFrame(updateCounter)
      } else {
        element.textContent = end.toLocaleString('es-ES')
      }
    }

    requestAnimationFrame(updateCounter)
  }

  function initCounters() {
    const counters = document.querySelectorAll<HTMLElement>('[data-end]')

    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            animateCounter(entry.target as HTMLElement)
            observer.unobserve(entry.target)
          }
        })
      },
      { threshold: 0.5 }
    )

    counters.forEach((counter) => observer.observe(counter))
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initCounters)
  } else {
    initCounters()
  }

  document.addEventListener('astro:page-load', initCounters)
</script>
