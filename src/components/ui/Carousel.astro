---
import { Image } from 'astro:assets'
import Close from '@icons/ui/Close.astro'
import ButtonLink from '@/components/ui/ButtonLink.astro'
import type { ItemCarousel } from '@/types'

interface Props {
  items: ItemCarousel[]
  id: string
  loading?: 'eager' | 'lazy'
  eagerCount?: number
}

const { items, id, loading = 'lazy', eagerCount = 6 } = Astro.props
---

<div class="swiper-container-wrapper">
  <div class="swiper" data-swiper-id={id}>
    <div class="swiper-wrapper">
      {
        items.map((item, index) => (
          <div class="swiper-slide">
            <div class="relative h-full">
              <Image
                src={item.imagen}
                alt={item.titulo}
                width={800}
                height={1100}
                class="carousel-image h-full w-full cursor-zoom-in object-cover transition-transform hover:scale-105"
                loading={
                  loading === 'eager' && index < eagerCount ? 'eager' : 'lazy'
                }
                data-lightbox-trigger={id}
              />
              <div class="absolute inset-x-0 bottom-0 bg-linear-to-t from-black/70 to-transparent px-4 py-4">
                <div class="flex flex-col items-start gap-2">
                  {item.enlaces.map((enlace) => (
                    <ButtonLink variant={enlace.tipo} href={enlace.url}>
                      {enlace.texto}
                    </ButtonLink>
                  ))}
                </div>
              </div>
            </div>
          </div>
        ))
      }
    </div>

    <div class="swiper-button-next"></div>
    <div class="swiper-button-prev"></div>
  </div>

  <div class="swiper-pagination"></div>

  <!-- Lightbox Modal -->
  <div
    class="carousel-lightbox fixed inset-0 z-9999 hidden items-center justify-center bg-black/85"
    data-lightbox={id}
  >
    <button
      class="lightbox-close absolute top-5 right-5 z-10000 flex h-12 w-12 items-center justify-center rounded-full bg-white/15 text-2xl text-white transition-all hover:scale-110 hover:bg-white/25"
      aria-label="Cerrar imagen"
    >
      <Close />
    </button>
    <img
      class="lightbox-img max-h-[90vh] max-w-[95vw] rounded-lg object-contain shadow-2xl select-none"
      src=""
      alt="Zoom"
    />
  </div>
</div>

<style>
  .swiper {
    width: 100%;
    height: 550px;
  }

  .swiper-slide {
    width: 390px;
    overflow: hidden;
    border-radius: 1rem;
    border: 2px solid #e5e7eb;
  }

  .swiper-pagination {
    position: relative;
    margin-top: 20px;
  }

  .carousel-lightbox.active {
    display: flex;
  }
</style>

<script>
  import Swiper from 'swiper'
  import { Navigation, Pagination, Autoplay } from 'swiper/modules'

  import 'swiper/css'
  import 'swiper/css/navigation'
  import 'swiper/css/pagination'

  function initSwipers() {
    const swiperElements = document.querySelectorAll('[data-swiper-id]')

    swiperElements.forEach((element) => {
      // Prevenir reinicialización
      if (element.classList.contains('swiper-initialized')) return

      const swiperId = element.getAttribute('data-swiper-id')
      if (!swiperId) return

      // Inicializar Swiper
      const swiper = new Swiper(element as HTMLElement, {
        modules: [Navigation, Pagination, Autoplay],
        slidesPerView: 'auto',
        spaceBetween: 30,
        loop: true,
        autoplay: {
          delay: 8000,
          disableOnInteraction: false,
        },
        navigation: {
          nextEl: element.querySelector('.swiper-button-next') as HTMLElement,
          prevEl: element.querySelector('.swiper-button-prev') as HTMLElement,
        },
        pagination: {
          el: element.parentElement?.querySelector(
            '.swiper-pagination'
          ) as HTMLElement,
          clickable: true,
        },
        mousewheel: true,
        keyboard: true,
      })

      // Configurar Lightbox
      const wrapper = element.closest('.swiper-container-wrapper')
      if (!wrapper) return

      const lightbox = wrapper.querySelector(
        `[data-lightbox="${swiperId}"]`
      ) as HTMLElement
      const lightboxImg = lightbox?.querySelector(
        '.lightbox-img'
      ) as HTMLImageElement
      const lightboxClose = lightbox?.querySelector(
        '.lightbox-close'
      ) as HTMLElement
      const triggers = wrapper.querySelectorAll(
        `[data-lightbox-trigger="${swiperId}"]`
      )

      if (!lightbox || !lightboxImg || !lightboxClose) return

      // Funciones del Lightbox
      const openLightbox = (src: string) => {
        lightboxImg.src = src
        lightbox.classList.add('active')
        document.body.style.overflow = 'hidden'
        swiper.autoplay.stop()
      }

      const closeLightbox = () => {
        lightbox.classList.remove('active')
        document.body.style.overflow = ''
        swiper.autoplay.start()
      }

      // Event listeners
      triggers.forEach((img) => {
        img.addEventListener('click', (e) => {
          e.preventDefault()
          const src = (img as HTMLImageElement).src
          openLightbox(src)
        })
      })

      lightboxClose.addEventListener('click', (e) => {
        e.stopPropagation()
        closeLightbox()
      })

      lightbox.addEventListener('click', (e) => {
        if (e.target === lightbox) {
          closeLightbox()
        }
      })

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && lightbox.classList.contains('active')) {
          closeLightbox()
        }
      })
    })
  }

  // Inicializar cuando el DOM esté listo
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initSwipers)
  } else {
    initSwipers()
  }

  // Para View Transitions de Astro
  document.addEventListener('astro:page-load', initSwipers)
</script>
